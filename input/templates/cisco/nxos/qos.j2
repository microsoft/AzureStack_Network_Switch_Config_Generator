! qos.go.tmpl-qos
{# -------- Global Values -------- #}
{% set prefix = qos.name_prefix -%}
{% set qos_network_policy = prefix ~ "_NETWORK_QOS" -%}
{% set qos_queuing_policy = prefix ~ "_QUEUING" -%}
{% set qos_class_policy = prefix ~ "_QOS" -%}

{# -------- Network-QoS Policy (Ingress) -------- #}
policy-map type network-qos {{ qos_network_policy }}
{%- for tc in qos.traffic_classes %}
  class type network-qos c-8q-nq{{ tc.cos if tc.cos != 0 else 'default' }}
  {%- if tc.pause %}
    pause pfc-cos {{ tc.cos }}
  {%- endif %}
    mtu 9216
{%- endfor %}

{# -------- Class Maps (CoS match) -------- #}
{%- for tc in qos.traffic_classes if tc.cos != 0 %}
class-map type qos match-all {{ tc.name | upper }}
  match cos {{ tc.cos }}
{%- endfor %}

{# -------- QoS Policy Map (Marking) -------- #}
policy-map type qos {{ qos_class_policy }}
{%- for tc in qos.traffic_classes if tc.cos != 0 %}
  class {{ tc.name | upper }}
    set qos-group {{ tc.cos }}
{%- endfor %}

{# -------- Queuing Policy Map (Egress) -------- #}
policy-map type queuing {{ qos_queuing_policy }}
{%- set defined_cos = qos.traffic_classes | map(attribute='cos') | list %}
{%- for tc in qos.traffic_classes %}
  class type queuing c-out-8q-q{{ tc.cos if tc.cos != 0 else 'default' }}
    bandwidth remaining percent {{ tc.bandwidth_pct }}
  {%- if tc.ecn %}
    random-detect minimum-threshold 300 kbytes maximum-threshold 300 kbytes drop-probability 100 weight 0 ecn
  {%- endif %}
{%- endfor %}

{# -------- Apply to System -------- #}
system qos
  service-policy type queuing output {{ qos_queuing_policy }}
  service-policy type network-qos {{ qos_network_policy }}
